<div class="p-1 m-2">
  <div class="d-flex justify-content-between">
    <div
      class="d-flex align-items-center justify-content-center pointer-cursor"
      (click)="goBack()"
    >
      <span class="me-2 d-flex align-items-center">
        <img src="../../../assets/images/icons/left-arrow.svg" alt="Back" />
      </span>
      <b>
        <span class="back-btn-text"> Create Report </span>
      </b>
    </div>
  </div>
</div>
<div class="container mt-4">
  <h2>Upload → Extract → Submit)</h2>

  <div class="card p-3 mt-3">
    <h5 class="mb-2">1) Upload Bank Statement (PDF)</h5>
    <input
      class="form-control"
      type="file"
      multiple
      (change)="onFileChange($event)"
      accept="application/pdf"
    />
    <div class="small text-muted mt-1">
      Filenames must match those sent in the report JSON.
    </div>

    <button
      class="btn btn-outline-primary mt-3"
      (click)="extract()"
      [disabled]="extracting || !selectedFiles.length"
    >
      {{ extracting ? "Extracting…" : "Extract Bank Details" }}
    </button>
  </div>

  <form class="card p-3 mt-3" [formGroup]="form">
    <h5 class="mb-3">2) Verify / Fill Account Details</h5>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Report Name *</label>
        <input
          type="text"
          class="form-control"
          [class.is-invalid]="
            form.get('reportName')?.invalid && form.get('reportName')?.touched
          "
          formControlName="reportName"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">Report ID (optional)</label>
        <input type="text" class="form-control" formControlName="reportId" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Search Bank (min 3 chars)</label>
        <input
          type="text"
          class="form-control"
          placeholder="e.g. HDFC"
          formControlName="bankSearch"
        />
        <div *ngIf="banks.length" class="list-group mt-1">
          <button
            type="button"
            class="list-group-item list-group-item-action"
            *ngFor="let b of banks"
            (click)="pickBank(b)"
          >
            {{ b.name }} ({{ b.id }})
          </button>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Bank ID *</label>
        <input
          type="text"
          class="form-control"
          [class.is-invalid]="
            form.get('bankId')?.invalid && form.get('bankId')?.touched
          "
          formControlName="bankId"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">Account Number *</label>
        <input
          type="text"
          class="form-control"
          [class.is-invalid]="
            form.get('accountNumber')?.invalid &&
            form.get('accountNumber')?.touched
          "
          formControlName="accountNumber"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">Account Type *</label>
        <select
          class="form-select"
          [class.is-invalid]="
            form.get('accountType')?.invalid && form.get('accountType')?.touched
          "
          formControlName="accountType"
        >
          <option value="" disabled>Select…</option>
          <option [value]="1">Savings</option>
          <option [value]="2">Current</option>
          <option [value]="3">Overdraft / Cash Credit</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Account Reference (optional)</label>
        <input
          type="text"
          class="form-control"
          formControlName="accountReferenceNumber"
          placeholder="e.g. HDFC_BANK_1"
        />
      </div>

      <div class="col-md-3">
        <label class="form-label">Analysis Start Date</label>
        <input
          type="date"
          class="form-control"
          formControlName="analysisStartDate"
        />
      </div>

      <div class="col-md-3">
        <label class="form-label">Analysis End Date</label>
        <input
          type="date"
          class="form-control"
          formControlName="analysisEndDate"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">PDF Password (optional)</label>
        <input type="text" class="form-control" formControlName="password" />
      </div>
    </div>

    <div class="mt-3">
      <strong>Files to send:</strong>
      <ul class="mb-0">
        <li *ngFor="let fn of fileNames">{{ fn }}</li>
      </ul>
    </div>
    <div class="mt-3" *ngIf="uploadedFiles.length">
      <strong>Already Uploaded Files:</strong>
      <ul class="mb-0">
        <li *ngFor="let f of uploadedFiles">
          {{ f.originalName }}
          <span class="text-muted">({{ f.status }})</span>
        </li>
      </ul>
    </div>

    <div class="mt-3" *ngIf="fileNames.length">
      <strong>Newly Selected Files:</strong>
      <ul class="mb-0">
        <li *ngFor="let fn of fileNames">{{ fn }}</li>
      </ul>
    </div>
  </form>

  <div class="d-flex gap-2 mt-3">
    <button
      class="btn btn-success"
      (click)="saveReport()"
      [disabled]="creatingOrUpdating"
    >
      {{
        isEditMode
          ? creatingOrUpdating
            ? "Updating…"
            : "Update Report"
          : creatingOrUpdating
          ? "Creating…"
          : "Create Report"
      }}
    </button>
  </div>

  <div class="card p-3 mt-3" *ngIf="extractResult?.length">
    <h6>Extract Result (first file)</h6>
    <pre class="small mb-0">{{ extractResult?.[0] | json }}</pre>
  </div>
</div>

<p-dialog
  header="Bank Statement Analyzer"
  [(visible)]="analyzing"
  [modal]="true"
  [closable]="false"
>
  <div class="text-center p-4">
    <h4>Analyzing your bank statement...</h4>
  </div>
</p-dialog>

<p-dialog header="Analysis Completed" [(visible)]="analysisDone" [modal]="true">
  <div class="text-center p-4">
    <h4>Analysis completed successfully!</h4>
    <button
      pButton
      type="button"
      label="View Analysis"
      (click)="goToAnalysis(newAccountRef)"
    ></button>
  </div>
</p-dialog>
